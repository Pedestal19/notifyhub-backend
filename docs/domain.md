# NotifyHub Domain (v1)

This document defines the **domain decisions** for NotifyHub.
It is intentionally **provider-agnostic** (Twilio/Meta/etc. details live in `docs/integrations/`).

## 1) Core Concept

NotifyHub is an inbound-message platform that:
- receives messages from external channels via webhooks (SMS / WhatsApp / USSD)
- stores them reliably
- processes them asynchronously (enrichment, routing, retries)
- exposes them for reporting/export/integration

### How NotifyHub is used (end-to-end)

- A customer provisions inbound channels (SMS number, WhatsApp Business number, USSD shortcode) through a provider (Twilio, Africa’s Talking, Termii, Infobip, Meta, etc.).

- The customer configures the provider to deliver inbound traffic to NotifyHub via an HTTP webhook URL.

- When an end user sends a message, the provider POSTs the message payload to NotifyHub.

- NotifyHub ingests the payload through a provider-agnostic endpoint, persists an InboundMessage record with status RECEIVED, and emits an async job/event for further processing.

- The Worker consumes the job/event, applies processing logic (enrichment/routing), updates status, and (in later phases) forwards messages to downstream systems (webhooks/queues/internal APIs).

### Integration styles

- Webhook delivery (default / preferred): provider calls NotifyHub in real time.

- Provider API polling (future option): NotifyHub periodically pulls inbound messages from provider APIs if needed.

## 2) InboundMessage (v1 Entity)

Represents a single inbound message received by NotifyHub.

### Fields (v1)
- `id` (UUID) — primary identifier generated by NotifyHub
- `channel` (enum/string) — e.g. `SMS`, `WHATSAPP`, `USSD`
- `provider` (optional, v1.1) — e.g. `TWILIO`, `INFOBIP`, `META`
- `provider_message_id` (optional, v1.1) — used for idempotency when supported
- `phone_number` (string) — sender MSISDN
- `body` (text) — message content
- `status` (enum/string) — lifecycle state (see below)
- `received_at` (timestamp with timezone) — when the message was received (provider timestamp or server receive time)
- `created_at` (timestamp with timezone) — DB insert time
- `updated_at` (timestamp with timezone) — DB update time

### Constraints (v1)
- `channel`, `phone_number`, `body`, `status`, `received_at` are required
- store raw `phone_number` as string (format normalization is future work)

## 3) Status Lifecycle (v1)

Statuses represent internal processing state.

### Proposed statuses
- `RECEIVED` — stored successfully after webhook ingestion
- `PROCESSING` — worker is actively handling it
- `PROCESSED` — processing completed successfully
- `FAILED` — processing failed (may be retried)
- `DEAD_LETTER` (future) — exceeded retry policy and moved to DLQ

### Lifecycle (v1 happy path)
`RECEIVED -> PROCESSING -> PROCESSED`

### Failure path (v1)
`RECEIVED -> PROCESSING -> FAILED`
(retry/DLQ rules are v2)

## 4) Responsibilities (API vs Worker)

### API Service (notifyhub-api)
Owns:
- webhook ingestion endpoints (provider calls this)
- validation + normalization into domain model
- persistent write of `InboundMessage` with status `RECEIVED`
- exposing query endpoints for reporting (later)
- emitting an async job/event for the worker (later)

Does NOT own:
- retries / backoff / DLQ handling (worker owns this)

### Worker Service (notifyhub-worker)
Owns:
- asynchronous processing pipeline
- status transitions beyond `RECEIVED`
- retries/backoff/DLQ (future milestones)
- calling outbound integrations (webhooks/queues) in later phases

## 5) v1 Scope

### In scope (v1)
- Store inbound messages in Postgres
- One minimal ingestion endpoint (stub/provider-agnostic)
- Flyway migration for table creation
- Basic health endpoints (actuator)

### Out of scope (future)
- multi-tenant admin portal
- provider-specific signature validation (Twilio signing, Meta verification)
- retries/backoff/DLQ
- SQS/Kafka integration
- outbound delivery to third-party systems
- reporting UI and exports
